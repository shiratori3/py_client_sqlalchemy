SELECT DISTINCT (SELECT MAX(ID) FROM usrCWFZZYC WITH(NOLOCK) WHERE RWID=E.RWID) ID,
    [校验类型] = '数值异常：首列均为年份数开头，可能是多期数据录入有误',
    RWID,
    HBM_COUNT,
    HBM_MAX_DEC1
FROM (
    SELECT DISTINCT 
        RWID,
        HBM_COUNT,
        HBM_MAX_DEC1 = (SELECT MAX(CONVERT(INT, HBM))-1 FROM usrCWFZZYC WITH(NOLOCK) WHERE RWID=D.RWID GROUP BY RWID)
    FROM (
        SELECT DISTINCT 
            C.RWID,
            HBM_COUNT = COUNT(C.HBM)
        FROM (
            SELECT DISTINCT 
                A.RWID,
                A.HBM,
                A.MXKMYSMC,
                MXKMYSMC_NEXT = B.MXKMYSMC
            FROM (
                SELECT DISTINCT 
                    RWID, MXKMYSMC, 
                    HBM = CONVERT(INT, HBM)
                FROM usrCWFZZYC A WITH(NOLOCK) 
                WHERE 
                    RWID IS NOT NULL
                    --AND RWID = '4156798013860'
                    --AND RWID = '4157941223069' --1
                    AND MXKMYSMC LIKE '[12][09]%'
                    AND CWKMDM IN ('COI00000001Y','CIP00000003S','CIP00000002T','CBP000000042','CBP0000000DB','CBP0000000PC','CIP00000002W','CMR000000002','CBP0000000QO','CIP000000030','CIP000000033','CIP00000003Q','CBP000000004','CBP0000000QJ','COI000000013','COI00000001T','CBP00000005H','CCP00000000I','CBP0000000D2','CBP0000000D4','CBP0000000UL','CBP000000197','CBP000000058','CBP0000000UN','CBP00000009E','CCP00000000J','CCP00000000N','CBP000000004','CBP0000000C0','CBP0000000T2','CBP00000003O','CBP00000003W','CBP00000003R','CBP00000003X','CBP00000003Z','CBP00000003S','CBP00000003Y','CBP00000003P','CBP000000041','CBP00000003T','CBP0000000OS','CBP0000000O9','CBP0000000O7','CBP0000000O6','CBP0000000OA')
            ) A
            LEFT JOIN (
                SELECT DISTINCT 
                    RWID, MXKMYSMC, 
                    HBM = CONVERT(INT, HBM) - 1
                FROM usrCWFZZYC A WITH(NOLOCK) 
                WHERE 
                    RWID IS NOT NULL
                    --AND RWID = '4156798013860'
                    --AND RWID = '4157941223069' --1
                    AND MXKMYSMC LIKE '[12][09]%'
                    AND CWKMDM IN ('COI00000001Y','CIP00000003S','CIP00000002T','CBP000000042','CBP0000000DB','CBP0000000PC','CIP00000002W','CMR000000002','CBP0000000QO','CIP000000030','CIP000000033','CIP00000003Q','CBP000000004','CBP0000000QJ','COI000000013','COI00000001T','CBP00000005H','CCP00000000I','CBP0000000D2','CBP0000000D4','CBP0000000UL','CBP000000197','CBP000000058','CBP0000000UN','CBP00000009E','CCP00000000J','CCP00000000N','CBP000000004','CBP0000000C0','CBP0000000T2','CBP00000003O','CBP00000003W','CBP00000003R','CBP00000003X','CBP00000003Z','CBP00000003S','CBP00000003Y','CBP00000003P','CBP000000041','CBP00000003T','CBP0000000OS','CBP0000000O9','CBP0000000O7','CBP0000000O6','CBP0000000OA')
            ) B ON A.RWID = B.RWID AND A.HBM = B.HBM
            WHERE 
                B.MXKMYSMC IS NOT NULL
        ) C
        GROUP BY C.RWID
        HAVING MAX(C.HBM) = COUNT(C.HBM)
    ) D
) E
WHERE HBM_COUNT = HBM_MAX_DEC1
ORDER BY RWID
